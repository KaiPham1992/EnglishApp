//
//  DictionaryViewController.swift
//  EnglishApp
//
//  Created vinova on 5/15/19.
//  Copyright © 2019 demo. All rights reserved.
//
//  Template generated by Juanpe Catalán @JuanpeCMiOS
//

import UIKit
import DropDown

class DictionaryViewController: BaseViewController {

    @IBOutlet weak var lblSearch: UILabel!
    @IBOutlet weak var imgPolygon: UIImageView!
    @IBOutlet weak var lblDictionary: UILabel!
    @IBOutlet weak var viewDictionary: UIView!
    @IBOutlet weak var tfSearch: TextFieldBee!
    
    @IBOutlet weak var lblTextSearch: UILabel!
    @IBAction func searchVocabulary(_ sender: Any) {
        let text = tfSearch.text ?? ""
        if !isConnection {
            self.presenter?.getDetailVocabulary(id: idDictionary)
        } else {
            self.presenter?.lookWordOnline(dictionary_id: idDictionary, word: text)
        }
        
    }
    var presenter: DictionaryPresenterProtocol?
    let dropDownDictionary = DropDown()
    let dropDownSearch = DropDown()
    var idDictionary: Int = 0

    @IBAction func clickDictionary(_ sender: Any) {
        if dropDownDictionary.isHidden {
            self.rotateImage()
            dropDownDictionary.show()
        }
    }
    override func setUpViews() {
        super.setUpViews()
        self.presenter?.getListDictionary()
       lblSearch.text = LocalizableKey.search.showLanguage
        self.tabBarController?.tabBar.isHidden = true
        lblDictionary.text = LocalizableKey.vietnamese_to_english.showLanguage
        DispatchQueue.main.asyncAfter(deadline: .now()+0.2) {
            self.setupDropDown()
        }
    }

    override func setUpNavigation() {
        super.setUpNavigation()
        addBackToNavigation()
        setTitleNavigation(title: LocalizableKey.dictionaty.showLanguage)
        addButtonToNavigation(image: UIImage(named: "ic_settings")!, style: .right, action: #selector(clickButtonRight) )
    }
    
    @objc func clickButtonRight(){
        self.push(controller: MoreDictionaryRouter.createModule(),animated: true)
    }
    
    func setupDropDown(){
        //dropdownDictionary
        dropDownDictionary.anchorView = self.viewDictionary
        dropDownDictionary.backgroundColor = UIColor(red: 32/255, green: 181/255, blue: 85/255, alpha: 1)
//        dropDownDictionary.backgroundColor = UIColor.white
        dropDownDictionary.width = self.viewDictionary.frame.width
        dropDownDictionary.bottomOffset = CGPoint(x: 0, y: (viewDictionary.frame.height))
        dropDownDictionary.setupCornerRadius(0)
        dropDownDictionary.customCellConfiguration = { (index: Index, item: String, cell: DropDownCell) -> Void in
            return
        }
        // Action triggered on selection
        dropDownDictionary.selectionAction = { [unowned self] (index: Int, item: String) in
            self.lblDictionary.text = item
            self.rotateImage()
            self.dropDownDictionary.hide()
            
        }
        
        dropDownDictionary.cancelAction = { [unowned self] in
            self.rotateImage()
        }
        
        //dropdownSearch
        dropDownSearch.anchorView = self.tfSearch
        dropDownSearch.backgroundColor = UIColor.white
        dropDownSearch.width = self.tfSearch.frame.width
        dropDownSearch.bottomOffset = CGPoint(x: 0, y: (tfSearch.frame.height))
        dropDownSearch.setupCornerRadius(0)
        dropDownSearch.customCellConfiguration = { (index: Index, item: String, cell: DropDownCell) -> Void in
            return
        }
        // Action triggered on selection
        dropDownSearch.selectionAction = { [unowned self] (index: Int, item: String) in
            self.dropDownSearch.hide()
            DispatchQueue.main.async {
                self.getDetailVocabulary(index: index, item: item)
            }
        }
    }
    
    func getDetailVocabulary(index: Int,item: String){
        if item != "Không tìm thấy kết quả" {
            tfSearch.text = item
            if isConnection {
                self.presenter?.lookWordOnline(dictionary_id: idDictionary, word: tfSearch.text ?? "")
            } else {
                if let id = self.presenter?.listSearchVocabulary[index].id {
                    self.idDictionary = id
                }
            }
        }
    }
    
    func rotateImage(){
        UIView.animate(withDuration: 0.2) {
            self.imgPolygon.transform = self.imgPolygon.transform.rotated(by: CGFloat(Double.pi))
        }
    }
}

extension DictionaryViewController:DictionaryViewProtocol{
    func searchVocabularySuccessed(){
        let data = self.presenter?.listSearchVocabulary.map{$0.word} ?? []
        if data.count == 0 {
            dropDownSearch.dataSource = ["Không tìm thấy kết quả"]
        } else {
            dropDownSearch.dataSource = data
        }
        dropDownSearch.show()
    }
    
    func getDetailVocabularySuccessed() {
        lblTextSearch.text = self.presenter?.detailVocabulary?.explain&
    }
    
    func reloadDictionary(){
        if let dictionary = self.presenter?.listDictionary.first {
            self.lblDictionary.text = dictionary.name
            self.idDictionary = dictionary.id
        }
        self.dropDownDictionary.dataSource = self.presenter?.listDictionary.map{$0.name}.compactMap{$0} ?? []
    }
}
