//
//  QAViewController.swift
//  EnglishApp
//
//  Created Kai Pham on 5/13/19.
//  Copyright © 2019 demo. All rights reserved.
//
//  Template generated by Juanpe Catalán @JuanpeCMiOS
//

import UIKit

class QAViewController: BaseViewController {

	var presenter: QAPresenterProtocol?
    @IBOutlet weak var tbHistory: UITableView!
    @IBOutlet weak var lbWhatQa: UILabel!
    @IBOutlet weak var lbMessage: UILabel!
    @IBOutlet weak var lbOlderQA: UILabel!
    @IBOutlet weak var tfQuestion: UITextField!
    
    @IBOutlet weak var lbError: UILabel!
    @IBOutlet weak var heightError: NSLayoutConstraint!
    
    var listHistory = [QAEntity]() {
        didSet {
            tbHistory.reloadData()
        }
    }
    
    override func setTitleUI() {
        super.setTitleUI()
        hideTabbar()
        lbWhatQa.text = LocalizableKey.whatQA.showLanguage
        lbMessage.text = LocalizableKey.messageQA.showLanguage
        tfQuestion.placeholder = LocalizableKey.enterQA.showLanguage
        lbOlderQA.text = LocalizableKey.qAOlder.showLanguage
        heightError.constant = 0
        tfQuestion.addTarget(self, action: #selector(textDidChange), for: .editingChanged)
        tfQuestion.delegate = self
    }
    
    override func btnBackTapped() {
        showTabbar()
        self.pop()
    }
    
    override func setUpNavigation() {
        super.setUpNavigation()
        addBackToNavigation()
        setTitleNavigation(title: LocalizableKey.titleQA.showLanguage)
    }
	override func viewDidLoad() {
        super.viewDidLoad()
        configureTable()
        
        presenter?.getQA()
    }

    @IBAction func btnSearchTapped() {
        if UserDefaultHelper.shared.loginUserInfo?.amountHoney ?? 0 < 5 {
            PopUpHelper.shared.showNotEnoughtBee(completionNo: nil) {
                let storeViewController = StoreViewController()
                DispatchQueue.main.asyncAfter(deadline: .now() + 0.15, execute: {
                    storeViewController.moveToViewController(at: 1)
                })
                self.push(controller: storeViewController)
            }
        } else {
            if tfQuestion.text& == "" {
                heightError.constant = 18
                lbError.text = LocalizableKey.pleaseEnterQA.showLanguage
            } else {
                PopUpHelper.shared.showComfirmPopUp(message: "\(LocalizableKey.deductFiveHoney.showLanguage)", titleYes: "\(LocalizableKey.confirm.showLanguage)", titleNo: "\(LocalizableKey.cancel.showLanguage)") {
                    self.tfQuestion.text = ""
                    self.presenter?.sendQA(qa: self.tfQuestion.text&)
                }
            }
        }
    }

}


extension QAViewController: UITableViewDelegate, UITableViewDataSource {
    func configureTable() {
        tbHistory.delegate = self
        tbHistory.dataSource = self
        tbHistory.registerXibFile(QACell.self)
        tbHistory.separatorStyle = .none
        
        tbHistory.estimatedRowHeight = 55
        tbHistory.rowHeight = UITableView.automaticDimension
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeue(QACell.self, for: indexPath)
        cell.qa = listHistory[indexPath.item]
        return cell
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return listHistory.count
    }
    
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let vc = QADetailRouter.createModule(qa: self.listHistory[indexPath.item])
        self.push(controller: vc)
    }
}

extension QAViewController: QAViewProtocol {
    func didGetQA(list: [QAEntity]) {
        if list.isEmpty {
            showNoData()
        } else {
            hideNoData()
            self.listHistory = list
        }
    }
}

extension QAViewController: UITextFieldDelegate {
    func textField(_ textField: UITextField, shouldChangeCharactersIn range: NSRange, replacementString string: String) -> Bool {
        guard let textFieldText = textField.text,
            let rangeOfTextToReplace = Range(range, in: textFieldText) else {
                return false
        }
        let substringToReplace = textFieldText[rangeOfTextToReplace]
        let count = textFieldText.count - substringToReplace.count + string.count
        return count <= 255
    }
    
    @objc func textDidChange() {
        
        if tfQuestion.text& != "" {
            heightError.constant = 0
        }
        
        if tfQuestion.text?.count == 255 {
            lbError.text = LocalizableKey.pleaseEnter255Digit.showLanguage
            heightError.constant = 18
        } else {
            heightError.constant = 0
        }
    }
    
}
